<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marci Tanfolyama</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #080c14;
            --card: #0f1623;
            --card2: #151d2e;
            --border: #1e2d45;
            --primary: #3b82f6;
            --primary-glow: rgba(59,130,246,0.15);
            --accent: #06d6a0;
            --danger: #ef4444;
            --text: #e2e8f0;
            --muted: #64748b;
            --tester: #f59e0b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .modal-overlay.hidden { display: none !important; }

        .modal-box {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2.5rem;
            width: 360px;
            animation: popIn .3s cubic-bezier(.175,.885,.32,1.275);
        }
        @keyframes popIn { from { opacity:0; transform:scale(.92) translateY(10px); } to { opacity:1; transform:none; } }

        .modal-box h2 {
            font-family: 'Syne', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #fff 40%, var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .tabs { display: flex; gap: 4px; background: var(--bg); border-radius: 8px; padding: 4px; margin-bottom: 1.5rem; }
        .tab-btn {
            flex: 1; padding: 8px; border: none; border-radius: 6px;
            background: transparent; color: var(--muted); cursor: pointer;
            font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500;
            transition: .2s;
        }
        .tab-btn.active { background: var(--card2); color: var(--text); }

        .tester-section {
            margin-top: 1rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }
        .tester-toggle {
            display: flex; align-items: center; gap: 8px;
            color: var(--tester); font-size: 13px; cursor: pointer;
            background: none; border: none; font-family: 'DM Sans', sans-serif;
            font-weight: 500; padding: 6px 0;
        }
        .tester-toggle::before { content: 'üîë'; }

        input[type=text], input[type=email], input[type=password] {
            width: 100%; padding: 11px 14px;
            background: var(--bg); color: var(--text);
            border: 1px solid var(--border); border-radius: 8px;
            font-family: 'DM Sans', sans-serif; font-size: 14px;
            outline: none; transition: border-color .2s;
            margin-bottom: 10px;
        }
        input:focus { border-color: var(--primary); }

        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 600;
            cursor: pointer; transition: .2s; margin-top: 4px;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: #2563eb; }
        .btn-google { background: #fff; color: #111; }
        .btn-google:hover { background: #f0f0f0; }
        .btn-danger { background: var(--danger); color: #fff; font-size: 13px; padding: 8px; }
        .btn-sm { padding: 7px 14px; font-size: 13px; border-radius: 6px; width: auto; margin-top: 0; }
        .btn-accent { background: var(--accent); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        .err-msg { color: #f87171; font-size: 13px; min-height: 18px; margin-top: 6px; }
        .success-msg { color: var(--accent); font-size: 13px; min-height: 18px; margin-top: 4px; }

        .divider { display: flex; align-items: center; gap: 10px; color: var(--muted); font-size: 13px; margin: 12px 0; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 32px; height: 60px;
            border-bottom: 1px solid var(--border);
            background: rgba(8,12,20,.9);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }
        .logo { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 800; }
        .logo span { color: var(--primary); }

        .user-chip {
            display: flex; align-items: center; gap: 10px;
            background: var(--card); border: 1px solid var(--border);
            border-radius: 100px; padding: 5px 14px 5px 5px;
        }
        .user-chip img { width: 32px; height: 32px; border-radius: 50%; }
        .tester-badge {
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            background: rgba(245,158,11,.2); color: var(--tester);
            border-radius: 4px; padding: 2px 6px; letter-spacing: .05em;
        }

        .app-body { display: flex; flex: 1; }

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        aside {
            width: 260px; min-height: calc(100vh - 60px);
            background: var(--card); border-right: 1px solid var(--border);
            padding: 24px 16px; display: flex; flex-direction: column; gap: 4px;
            position: sticky; top: 60px; height: calc(100vh - 60px); overflow-y: auto;
        }
        .sidebar-label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; padding: 8px 10px 4px; }
        .nav-item {
            display: flex; align-items: center; gap: 10px;
            padding: 9px 12px; border-radius: 8px; cursor: pointer;
            font-size: 14px; color: var(--muted); transition: .15s;
            border: none; background: none; width: 100%; text-align: left;
            font-family: 'DM Sans', sans-serif;
        }
        .nav-item:hover { background: var(--card2); color: var(--text); }
        .nav-item.active { background: var(--primary-glow); color: var(--primary); }
        .nav-item .icon { width: 18px; text-align: center; }

        /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
        main { flex: 1; padding: 32px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }

        h1 { font-family: 'Syne', sans-serif; font-size: 1.8rem; font-weight: 800; margin-bottom: 8px; }
        h2 { font-family: 'Syne', sans-serif; font-size: 1.3rem; font-weight: 700; margin-bottom: 16px; }
        .subtitle { color: var(--muted); margin-bottom: 28px; font-size: 15px; }

        .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .course-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 12px; overflow: hidden; cursor: pointer;
            transition: transform .2s, border-color .2s;
        }
        .course-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .course-thumb {
            height: 140px; background: linear-gradient(135deg, var(--card2), var(--border));
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem;
        }
        .course-info { padding: 16px; }
        .course-title { font-family: 'Syne', sans-serif; font-weight: 700; margin-bottom: 4px; }
        .course-meta { font-size: 12px; color: var(--muted); }
        .course-actions { display: flex; gap: 8px; padding: 0 16px 16px; }

        .video-wrapper {
            width: 100%; max-width: 860px; aspect-ratio: 16/9;
            background: #000; border-radius: 12px; overflow: hidden;
            border: 1px solid var(--border); margin-bottom: 24px;
        }
        .video-wrapper iframe, .video-wrapper > div { width: 100% !important; height: 100% !important; }

        .admin-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; margin-bottom: 20px;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px 12px;
            background: var(--bg); color: var(--text);
            border: 1px solid var(--border); border-radius: 8px;
            font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none;
            transition: border-color .2s; resize: vertical;
        }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--primary); }

        .lesson-list-editor { list-style: none; }
        .lesson-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; background: var(--bg);
            border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;
        }
        .lesson-item span { flex: 1; font-size: 14px; }
        .lesson-num { width: 24px; height: 24px; border-radius: 50%; background: var(--primary-glow); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 12px; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tr:last-child td { border-bottom: none; }

        .tag { display: inline-block; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; }
        .tag-tester { background: rgba(245,158,11,.15); color: var(--tester); }
        .tag-user { background: rgba(100,116,139,.15); color: var(--muted); }

        .hidden { display: none !important; }

        .progress-bar { height: 4px; background: var(--border); border-radius: 2px; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width .5s; }

        .tester-glow {
            background: linear-gradient(135deg, rgba(245,158,11,.08), transparent);
            border: 1px solid rgba(245,158,11,.2); border-radius: 8px;
            padding: 10px 12px; margin-bottom: 8px; font-size: 13px; color: var(--tester);
        }
    </style>
</head>
<body>

<!-- AUTH MODAL -->
<div id="auth-modal" class="modal-overlay">
    <div class="modal-box">
        <h2 id="modal-title">Bejelentkez√©s</h2>
        <div class="tabs">
            <button class="tab-btn active" id="tab-btn-login" onclick="switchTab('login')">Bel√©p√©s</button>
            <button class="tab-btn" id="tab-btn-register" onclick="switchTab('register')">Regisztr√°ci√≥</button>
        </div>

        <div id="tab-login">
            <input type="email" id="login-email" placeholder="E-mail c√≠m">
            <input type="password" id="login-pass" placeholder="Jelsz√≥">
            <button class="btn btn-primary" onclick="doLogin()">Bel√©p√©s</button>
            <div class="divider">vagy</div>
            <button class="btn btn-google" onclick="doGoogle()">üîµ Google bejelentkez√©s</button>
        </div>

        <div id="tab-register" class="hidden">
            <input type="text" id="reg-name" placeholder="Teljes neved">
            <input type="email" id="reg-email" placeholder="E-mail c√≠m">
            <input type="password" id="reg-pass" placeholder="Jelsz√≥ (min. 6 karakter)">
            <div class="tester-section">
                <button class="tester-toggle" onclick="toggleTesterArea()">TESZTER VAGY?</button>
                <div id="tester-code-area" class="hidden" style="margin-top:8px;">
                    <input type="text" id="tester-code" placeholder="Add meg a teszter k√≥dot...">
                </div>
            </div>
            <button class="btn btn-primary" style="margin-top:12px;" onclick="doRegister()">Regisztr√°ci√≥</button>
            <div class="divider">vagy</div>
            <button class="btn btn-google" onclick="doGoogle()">üîµ Google bejelentkez√©s</button>
        </div>

        <p class="err-msg" id="auth-error"></p>
    </div>
</div>

<!-- HEADER -->
<header>
    <div class="logo">Marci<span>.</span>Tanfolyam</div>
    <div id="user-chip-area" class="hidden">
        <div class="user-chip">
            <img id="header-avatar" src="" alt="">
            <span id="header-name" style="font-size:14px;"></span>
            <span id="header-tester-badge" class="tester-badge hidden">Teszter</span>
            <button style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:0 0 0 8px;" onclick="doLogout()">Kil√©p√©s</button>
        </div>
    </div>
</header>

<div class="app-body">
    <!-- SIDEBAR -->
    <aside id="sidebar" class="hidden">
        <div class="sidebar-label">Navig√°ci√≥</div>
        <button class="nav-item active" id="nav-courses" onclick="showPage('courses')">
            <span class="icon">üéì</span> Kurzusok
        </button>
        <button class="nav-item" id="nav-profile" onclick="showPage('profile')">
            <span class="icon">üë§</span> Profil
        </button>

        <div id="tester-nav" class="hidden" style="margin-top:16px;">
            <div class="tester-glow">üîë Teszter panel</div>
            <div class="sidebar-label">Admin</div>
            <button class="nav-item" id="nav-create-course" onclick="showPage('create-course')">
                <span class="icon">‚ûï</span> Kurzus l√©trehoz√°sa
            </button>
            <button class="nav-item" id="nav-manage-courses" onclick="showPage('manage-courses')">
                <span class="icon">üìã</span> Kurzusok kezel√©se
            </button>
            <button class="nav-item" id="nav-manage-users" onclick="showPage('manage-users')">
                <span class="icon">üë•</span> Felhaszn√°l√≥k
            </button>
        </div>
    </aside>

    <!-- MAIN -->
    <main id="main-content" class="hidden">

        <!-- KURZUSOK -->
        <div id="page-courses" class="page active">
            <h1>Kurzusok</h1>
            <p class="subtitle">V√°lassz egy kurzust a tanul√°shoz.</p>
            <div id="courses-grid" class="course-grid">
                <div style="color:var(--muted);font-size:14px;">Bet√∂lt√©s...</div>
            </div>
        </div>

        <!-- VIDE√ì LEJ√ÅTSZ√ì -->
        <div id="page-player" class="page">
            <button class="btn btn-outline btn-sm" style="margin-bottom:20px;" onclick="showPage('courses')">‚Üê Vissza</button>
            <h1 id="player-title"></h1>
            <p class="subtitle" id="player-lesson-name"></p>
            <div class="video-wrapper">
                <div id="yt-player"></div>
            </div>
            <p id="player-status" style="color:var(--muted);font-size:14px;margin-bottom:12px;">N√©zd v√©gig a vide√≥t!</p>
            <button id="next-lesson-btn" class="btn btn-accent btn-sm" disabled onclick="nextLesson()">K√∂vetkez≈ë lecke ‚Üí</button>
            <div style="margin-top:24px;">
                <div style="font-size:13px;color:var(--muted);margin-bottom:6px;">Halad√°s</div>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
            </div>
            <div id="lesson-list-player" style="margin-top:24px;"></div>
        </div>

        <!-- PROFIL -->
        <div id="page-profile" class="page">
            <h1>Profil</h1>
            <div class="admin-card" style="max-width:480px;">
                <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
                    <img id="profile-avatar" style="width:64px;height:64px;border-radius:50%;border:2px solid var(--primary);" src="" alt="">
                    <div>
                        <div id="profile-name" style="font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;"></div>
                        <div id="profile-email" style="color:var(--muted);font-size:13px;"></div>
                        <div id="profile-role" style="margin-top:4px;"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Megjelen√≠tett n√©v m√≥dos√≠t√°sa</label>
                    <input type="text" id="profile-new-name" placeholder="√öj n√©v">
                </div>
                <button class="btn btn-primary btn-sm" onclick="saveProfileName()">Ment√©s</button>
                <p class="success-msg" id="profile-save-msg"></p>
            </div>
        </div>

        <!-- KURZUS L√âTREHOZ√ÅSA -->
        <div id="page-create-course" class="page">
            <h1>√öj kurzus l√©trehoz√°sa</h1>
            <p class="subtitle">T√∂ltsd ki az adatokat √©s add hozz√° a leck√©ket.</p>
            <div class="admin-card" style="max-width:680px;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Kurzus neve *</label>
                        <input type="text" id="nc-title" placeholder="pl. Python alapok">
                    </div>
                    <div class="form-group">
                        <label>Emoji / ikon</label>
                        <input type="text" id="nc-emoji" placeholder="üêç" maxlength="2" value="üéì">
                    </div>
                </div>
                <div class="form-group">
                    <label>Le√≠r√°s</label>
                    <textarea id="nc-desc" rows="3" placeholder="Mire tan√≠tja meg a hallgat√≥t?"></textarea>
                </div>

                <h2>Leck√©k</h2>
                <ul class="lesson-list-editor" id="lesson-list-editor"></ul>

                <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;">
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Lecke neve</label>
                            <input type="text" id="nl-title" placeholder="pl. V√°ltoz√≥k √©s adatt√≠pusok">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>YouTube Video ID</label>
                            <input type="text" id="nl-video" placeholder="pl. LXb3EKWsInQ">
                        </div>
                    </div>
                    <button class="btn btn-outline btn-sm" style="margin-top:10px;" onclick="addLesson()">+ Lecke hozz√°ad√°sa</button>
                </div>

                <button class="btn btn-primary" onclick="saveCourse()">üíæ Kurzus ment√©se</button>
                <p class="success-msg" id="nc-msg"></p>
            </div>
        </div>

        <!-- KURZUSOK KEZEL√âSE -->
        <div id="page-manage-courses" class="page">
            <h1>Kurzusok kezel√©se</h1>
            <p class="subtitle">Megl√©v≈ë kurzusok szerkeszt√©se √©s t√∂rl√©se.</p>
            <div id="manage-courses-list"></div>
        </div>

        <!-- FELHASZN√ÅL√ìK -->
        <div id="page-manage-users" class="page">
            <h1>Felhaszn√°l√≥k</h1>
            <p class="subtitle">Regisztr√°lt felhaszn√°l√≥k list√°ja.</p>
            <div class="admin-card">
                <table>
                    <thead>
                        <tr>
                            <th>N√©v</th><th>E-mail</th><th>Szerep</th><th>Regisztr√°lva</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr><td colspan="4" style="color:var(--muted);">Bet√∂lt√©s...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
    getAuth, GoogleAuthProvider, signInWithPopup,
    signInWithEmailAndPassword, createUserWithEmailAndPassword,
    onAuthStateChanged, updateProfile, signOut
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import {
    getFirestore, doc, getDoc, setDoc, updateDoc,
    collection, addDoc, getDocs, deleteDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const TESTER_CODE = "201309042444";
const firebaseConfig = {
    apiKey: "AIzaSyA9qoO7HEw7mxmAW8ienO-5Uh3qlOKpCIo",
    authDomain: "marci-tanfolyam.firebaseapp.com",
    projectId: "marci-tanfolyam",
    storageBucket: "marci-tanfolyam.firebasestorage.app",
    messagingSenderId: "1030798395423",
    appId: "1:1030798395423:web:44e99837acd08499e02d2a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let currentUser = null;
let isTester = false;
let pendingLessons = [];
let ytPlayer = null;
let currentCourse = null;
let currentLessonIdx = 0;
let ytReady = false;
let uiReady = false; // megakad√°lyozza hogy az onAuthStateChanged fel√ºl√≠rja a regisztr√°ci√≥t

window.switchTab = (tab) => {
    document.getElementById('tab-login').classList.toggle('hidden', tab !== 'login');
    document.getElementById('tab-register').classList.toggle('hidden', tab !== 'register');
    document.getElementById('modal-title').innerText = tab === 'login' ? 'Bejelentkez√©s' : 'Regisztr√°ci√≥';
    document.getElementById('tab-btn-login').classList.toggle('active', tab === 'login');
    document.getElementById('tab-btn-register').classList.toggle('active', tab !== 'login');
    setErr('');
};

window.toggleTesterArea = () => {
    document.getElementById('tester-code-area').classList.toggle('hidden');
};

function setErr(msg) { document.getElementById('auth-error').innerText = msg; }

// ‚îÄ‚îÄ F≈ê UI SETUP ‚Äì ezt h√≠vjuk login √©s regisztr√°ci√≥ ut√°n is ‚îÄ‚îÄ
async function setupUI(user, userData) {
    uiReady = true;
    currentUser = user;
    isTester = userData.role === 'tester';

    document.getElementById('auth-modal').classList.add('hidden');
    document.getElementById('sidebar').classList.remove('hidden');
    document.getElementById('main-content').classList.remove('hidden');
    document.getElementById('user-chip-area').classList.remove('hidden');

    const avatar = user.photoURL || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.uid}`;
    document.getElementById('header-avatar').src = avatar;
    document.getElementById('header-name').innerText = userData.name || user.displayName || user.email;
    document.getElementById('header-tester-badge').classList.toggle('hidden', !isTester);

    document.getElementById('profile-avatar').src = avatar;
    document.getElementById('profile-name').innerText = userData.name || user.displayName || 'N√©vtelen';
    document.getElementById('profile-email').innerText = user.email;
    document.getElementById('profile-role').innerHTML = isTester
        ? '<span class="tag tag-tester">üîë Teszter</span>'
        : '<span class="tag tag-user">Felhaszn√°l√≥</span>';

    if (isTester) document.getElementById('tester-nav').classList.remove('hidden');

    if (!document.querySelector('script[src*="youtube.com/iframe_api"]')) {
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
    }

    loadCourses();
}

window.doLogin = async () => {
    const email = document.getElementById('login-email').value.trim();
    const pass = document.getElementById('login-pass').value;
    if (!email || !pass) { setErr('T√∂ltsd ki a mez≈ëket!'); return; }
    try { await signInWithEmailAndPassword(auth, email, pass); }
    catch(e) { setErr(e.code === 'auth/invalid-credential' ? 'Hib√°s e-mail vagy jelsz√≥.' : e.message); }
};

window.doRegister = async () => {
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const pass = document.getElementById('reg-pass').value;
    const code = document.getElementById('tester-code').value.trim();
    if (!name || !email || !pass) { setErr('T√∂ltsd ki az √∂sszes mez≈ët!'); return; }
    if (pass.length < 6) { setErr('A jelsz√≥ legal√°bb 6 karakter!'); return; }
    if (code && code !== TESTER_CODE) { setErr('√ârv√©nytelen teszter k√≥d!'); return; }
    const role = code === TESTER_CODE ? 'tester' : 'user';
    try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name });

        const userData = { name, email, role, createdAt: new Date().toISOString() };

        // Firestore √≠r√°s EL≈êBB, setupUI UT√ÅNA ‚Äì az onAuthStateChanged le van tiltva (uiReady=true)
        await setDoc(doc(db, "users", cred.user.uid), userData);
        await setupUI(cred.user, userData);
    } catch(e) {
        setErr(e.code === 'auth/email-already-in-use' ? 'Ez az e-mail m√°r regisztr√°lt.' : e.message);
    }
};

window.doGoogle = async () => {
    try {
        const cred = await signInWithPopup(auth, provider);
        const ref = doc(db, "users", cred.user.uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
            await setDoc(ref, {
                name: cred.user.displayName || cred.user.email,
                email: cred.user.email,
                role: 'user',
                createdAt: new Date().toISOString()
            });
        }
        // Google loginn√°l az onAuthStateChanged kezeli
    } catch(e) { setErr(e.message); }
};

window.doLogout = async () => { await signOut(auth); location.reload(); };

// ‚îÄ‚îÄ AUTH STATE ‚Äì csak login √©s oldalbet√∂lt√©s eset√©n fut le ‚îÄ‚îÄ
onAuthStateChanged(auth, async (user) => {
    if (uiReady) return; // regisztr√°ci√≥ m√°r be√°ll√≠totta az UI-t, nem kell √∫jra
    if (user) {
        const snap = await getDoc(doc(db, "users", user.uid));
        const userData = snap.exists() ? snap.data() : { role: 'user', name: user.displayName || user.email };
        await setupUI(user, userData);
    } else {
        document.getElementById('auth-modal').classList.remove('hidden');
        document.getElementById('sidebar').classList.add('hidden');
        document.getElementById('main-content').classList.add('hidden');
        document.getElementById('user-chip-area').classList.add('hidden');
    }
});

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
window.showPage = (page) => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    const navEl = document.getElementById('nav-' + page);
    if (navEl) navEl.classList.add('active');
    if (page === 'manage-users') loadUsers();
    if (page === 'manage-courses') loadManageCourses();
};

// ‚îÄ‚îÄ COURSES ‚îÄ‚îÄ
async function loadCourses() {
    const grid = document.getElementById('courses-grid');
    grid.innerHTML = '';
    try {
        const snap = await getDocs(query(collection(db, "courses"), orderBy("createdAt", "desc")));
        if (snap.empty) { grid.innerHTML = '<div style="color:var(--muted);font-size:14px;">M√©g nincsenek kurzusok.</div>'; return; }
        snap.forEach(d => {
            const c = { id: d.id, ...d.data() };
            const card = document.createElement('div');
            card.className = 'course-card';
            card.innerHTML = `
                <div class="course-thumb">${c.emoji || 'üéì'}</div>
                <div class="course-info">
                    <div class="course-title">${c.title}</div>
                    <div class="course-meta">${(c.lessons||[]).length} lecke ‚Ä¢ ${c.description||''}</div>
                </div>
                <div class="course-actions">
                    <button class="btn btn-primary btn-sm" onclick="openCourse('${c.id}')">Megnyit√°s</button>
                </div>
            `;
            grid.appendChild(card);
        });
    } catch(e) {
        grid.innerHTML = `<div style="color:#f87171;">Hiba a kurzusok bet√∂lt√©sekor: ${e.message}</div>`;
    }
}

window.openCourse = async (courseId) => {
    const snap = await getDoc(doc(db, "courses", courseId));
    if (!snap.exists()) return;
    currentCourse = { id: snap.id, ...snap.data() };
    currentLessonIdx = 0;
    showPage('player');
    document.getElementById('player-title').innerText = currentCourse.title;
    renderLessonListPlayer();
    loadLesson(0);
};

function loadLesson(idx) {
    const lesson = currentCourse.lessons[idx];
    if (!lesson) return;
    currentLessonIdx = idx;
    document.getElementById('player-lesson-name').innerText = `${idx+1}. lecke: ${lesson.title}`;
    document.getElementById('player-status').innerText = 'N√©zd v√©gig a vide√≥t!';
    document.getElementById('next-lesson-btn').disabled = true;
    document.getElementById('progress-fill').style.width = Math.round((idx / currentCourse.lessons.length) * 100) + '%';
    renderLessonListPlayer();

    if (ytReady) {
        if (ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
            ytPlayer.loadVideoById(lesson.videoId);
        } else {
            createPlayer(lesson.videoId);
        }
    }
    // else: onYouTubeIframeAPIReady will handle it
}

function createPlayer(videoId) {
    document.getElementById('yt-player').innerHTML = '';
    ytPlayer = new YT.Player('yt-player', {
        videoId,
        width: '100%', height: '100%',
        playerVars: { enablejsapi: 1, origin: location.origin, rel: 0 },
        events: {
            onError: () => {
                document.getElementById('player-status').innerText = '‚ö†Ô∏è Ez a vide√≥ nem j√°tszhat√≥ le be√°gyazva. Ellen≈ërizd a Video ID-t.';
                document.getElementById('next-lesson-btn').disabled = false;
            },
            onStateChange: (e) => {
                if (e.data === YT.PlayerState.ENDED) {
                    document.getElementById('next-lesson-btn').disabled = false;
                    document.getElementById('player-status').innerText = '‚úÖ K√©sz! Mehet tov√°bb.';
                    const pct = Math.round(((currentLessonIdx+1) / currentCourse.lessons.length) * 100);
                    document.getElementById('progress-fill').style.width = pct + '%';
                }
            }
        }
    });
}

window.onYouTubeIframeAPIReady = () => {
    ytReady = true;
    if (currentCourse && currentCourse.lessons) {
        createPlayer(currentCourse.lessons[currentLessonIdx].videoId);
    }
};

function renderLessonListPlayer() {
    const el = document.getElementById('lesson-list-player');
    el.innerHTML = '<h2 style="margin-bottom:12px;">Leck√©k</h2>';
    (currentCourse.lessons || []).forEach((l, i) => {
        const btn = document.createElement('button');
        btn.className = 'nav-item' + (i === currentLessonIdx ? ' active' : '');
        btn.innerHTML = `<span class="lesson-num">${i+1}</span> ${l.title}`;
        btn.onclick = () => loadLesson(i);
        el.appendChild(btn);
    });
}

window.nextLesson = () => {
    if (currentLessonIdx + 1 < currentCourse.lessons.length) {
        loadLesson(currentLessonIdx + 1);
    } else {
        document.getElementById('player-status').innerText = 'üéâ Gratul√°lok! Elv√©gezted a kurzust!';
        document.getElementById('next-lesson-btn').disabled = true;
        document.getElementById('progress-fill').style.width = '100%';
    }
};

// ‚îÄ‚îÄ TESTER: KURZUS L√âTREHOZ√ÅS ‚îÄ‚îÄ
window.addLesson = () => {
    const title = document.getElementById('nl-title').value.trim();
    const videoId = document.getElementById('nl-video').value.trim();
    if (!title || !videoId) { alert('Add meg a lecke nev√©t √©s a Video ID-t!'); return; }
    pendingLessons.push({ title, videoId });
    document.getElementById('nl-title').value = '';
    document.getElementById('nl-video').value = '';
    renderLessonEditor();
};

window.removeLesson = (i) => { pendingLessons.splice(i, 1); renderLessonEditor(); };

function renderLessonEditor() {
    const ul = document.getElementById('lesson-list-editor');
    ul.innerHTML = '';
    pendingLessons.forEach((l, i) => {
        const li = document.createElement('li');
        li.className = 'lesson-item';
        li.innerHTML = `
            <span class="lesson-num">${i+1}</span>
            <span>${l.title} <span style="color:var(--muted);font-size:12px;">[${l.videoId}]</span></span>
            <button class="btn btn-danger btn-sm" onclick="removeLesson(${i})">‚úï</button>
        `;
        ul.appendChild(li);
    });
}

window.saveCourse = async () => {
    const title = document.getElementById('nc-title').value.trim();
    const emoji = document.getElementById('nc-emoji').value.trim() || 'üéì';
    const description = document.getElementById('nc-desc').value.trim();
    if (!title) { alert('Add meg a kurzus nev√©t!'); return; }
    if (pendingLessons.length === 0) { alert('Adj hozz√° legal√°bb egy leck√©t!'); return; }
    try {
        await addDoc(collection(db, "courses"), {
            title, emoji, description,
            lessons: pendingLessons,
            createdBy: currentUser.uid,
            createdAt: new Date().toISOString()
        });
        document.getElementById('nc-msg').innerText = '‚úÖ Kurzus sikeresen mentve!';
        document.getElementById('nc-title').value = '';
        document.getElementById('nc-desc').value = '';
        document.getElementById('nc-emoji').value = 'üéì';
        pendingLessons = [];
        renderLessonEditor();
        loadCourses();
        setTimeout(() => document.getElementById('nc-msg').innerText = '', 3000);
    } catch(e) { alert('Hiba: ' + e.message); }
};

// ‚îÄ‚îÄ TESTER: KURZUSOK KEZEL√âSE ‚îÄ‚îÄ
async function loadManageCourses() {
    const container = document.getElementById('manage-courses-list');
    container.innerHTML = '<div style="color:var(--muted);">Bet√∂lt√©s...</div>';
    const snap = await getDocs(query(collection(db, "courses"), orderBy("createdAt", "desc")));
    container.innerHTML = '';
    if (snap.empty) { container.innerHTML = '<div style="color:var(--muted);">Nincsenek kurzusok.</div>'; return; }
    snap.forEach(d => {
        const c = { id: d.id, ...d.data() };
        const card = document.createElement('div');
        card.className = 'admin-card';
        card.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
                <div>
                    <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:1.1rem;">${c.emoji} ${c.title}</div>
                    <div style="color:var(--muted);font-size:13px;margin-top:2px;">${(c.lessons||[]).length} lecke ‚Ä¢ ${c.description||''}</div>
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-outline btn-sm" onclick="openCourse('${c.id}')">üëÅ Megtekint√©s</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteCourse('${c.id}', this)">üóë T√∂rl√©s</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

window.deleteCourse = async (id, btn) => {
    if (!confirm('Biztosan t√∂rl√∂d ezt a kurzust?')) return;
    btn.disabled = true;
    await deleteDoc(doc(db, "courses", id));
    loadManageCourses(); loadCourses();
};

// ‚îÄ‚îÄ TESTER: FELHASZN√ÅL√ìK ‚îÄ‚îÄ
async function loadUsers() {
    const tbody = document.getElementById('users-table-body');
    tbody.innerHTML = '<tr><td colspan="4" style="color:var(--muted);">Bet√∂lt√©s...</td></tr>';
    try {
        const snap = await getDocs(collection(db, "users"));
        tbody.innerHTML = '';
        snap.forEach(d => {
            const u = d.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${u.name||'‚Äî'}</td>
                <td style="color:var(--muted);">${u.email||'‚Äî'}</td>
                <td><span class="tag ${u.role==='tester'?'tag-tester':'tag-user'}">${u.role==='tester'?'üîë Teszter':'Felhaszn√°l√≥'}</span></td>
                <td style="color:var(--muted);font-size:12px;">${u.createdAt?u.createdAt.slice(0,10):'‚Äî'}</td>
            `;
            tbody.appendChild(tr);
        });
    } catch(e) {
        tbody.innerHTML = `<tr><td colspan="4" style="color:#f87171;">Hiba: ${e.message}</td></tr>`;
    }
}

// ‚îÄ‚îÄ PROFIL ‚îÄ‚îÄ
window.saveProfileName = async () => {
    const name = document.getElementById('profile-new-name').value.trim();
    if (!name) return;
    await updateProfile(auth.currentUser, { displayName: name });
    await updateDoc(doc(db, "users", currentUser.uid), { name });
    document.getElementById('profile-name').innerText = name;
    document.getElementById('header-name').innerText = name;
    document.getElementById('profile-new-name').value = '';
    document.getElementById('profile-save-msg').innerText = '‚úÖ Mentve!';
    setTimeout(() => document.getElementById('profile-save-msg').innerText = '', 2500);
};
</script>
</body>
</html>
